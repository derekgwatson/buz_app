{% extends "layout.html" %}
{% block title %}Quote History Scraper{% endblock %}

{% block head %}
<style>
  .ok { color: #0a7f36; }
  .warn { color: #b54708; }
  .err { color: #b42318; }
  .info { color: #026aa2; }
  code { background: #f6f8fa; padding: 2px 6px; border-radius: 4px; }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 500;
  }

  .form-group input[type="text"],
  .form-group select {
    width: 100%;
    max-width: 500px;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 1rem;
  }

  .form-group input[type="checkbox"] {
    margin-right: 0.5rem;
  }

  .btn {
    padding: 0.6rem 1.2rem;
    border: 0;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
  }

  .btn-primary {
    background: #2563eb;
    color: white;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  .btn-primary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: #6b7280;
    color: white;
    margin-left: 0.5rem;
  }

  .btn-secondary:hover {
    background: #4b5563;
  }

  #progressSection {
    display: none;
    margin-top: 2rem;
  }

  #progressBar {
    width: 100%;
    max-width: 600px;
    height: 30px;
  }

  #progressPct {
    margin-top: 0.5rem;
    font-size: 1.1rem;
    font-weight: 500;
  }

  #progressLog {
    margin-top: 1rem;
    padding: 1rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    max-height: 400px;
    overflow-y: auto;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  #resultSection {
    display: none;
    margin-top: 2rem;
    padding: 1rem;
    background: #f0fdf4;
    border: 1px solid #86efac;
    border-radius: 0.5rem;
    color: #065f46;
  }

  #resultSection.error {
    background: #fef2f2;
    border-color: #fca5a5;
    color: #991b1b;
  }

  .result-summary {
    margin-top: 0.5rem;
    white-space: pre-line;
  }

  .history-table {
    width: 100%;
    margin-top: 1rem;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .history-table th {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    text-align: left;
    font-weight: 600;
  }

  .history-table td {
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    vertical-align: top;
  }

  .history-table tr:nth-child(even) {
    background: #f9fafb;
  }

  .details-cell {
    max-width: 500px;
    word-wrap: break-word;
  }

  .download-section {
    margin-top: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<h2>Quote History Scraper</h2>

<p class="info">Scrape complete quote history from Buz Manager, including all notes and changes.</p>

<form id="scraperForm">
  <div class="form-group">
    <label for="order_id">Order/Quote ID:</label>
    <input type="text" id="order_id" name="order_id"
           placeholder="e.g., 39e27815-b2c5-469f-9cea-63f6dcc32976"
           pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}"
           required>
    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.3rem;">
      Enter the GUID from the Buz quote URL: <code>Sales/Summary?orderId=...</code>
    </p>
  </div>

  <div class="form-group">
    <label for="account">Buz Account:</label>
    <select id="account" name="account">
      <option value="watsonblinds">Watson Blinds</option>
      <option value="designerdrapes">Designer Drapes</option>
    </select>
  </div>

  <div class="form-group">
    <label>
      <input type="checkbox" id="headless" name="headless" checked>
      Run in headless mode (no browser window)
    </label>
  </div>

  <button type="submit" class="btn btn-primary" id="submitBtn">Start Scraping</button>
</form>

<div id="progressSection">
  <h3>Progress</h3>
  <progress id="progressBar" max="100" value="0"></progress>
  <div id="progressPct">0%</div>
  <pre id="progressLog"></pre>
</div>

<div id="resultSection">
  <h3 id="resultTitle">Result</h3>
  <div class="result-summary" id="resultSummary"></div>

  <div class="download-section" id="downloadSection" style="display: none;">
    <button class="btn btn-secondary" id="downloadBtn">Download JSON</button>
  </div>

  <div id="resultDetails"></div>
</div>

<script>
let currentJobId = null;
let poller = null;
let resultData = null;

const form = document.getElementById('scraperForm');
const submitBtn = document.getElementById('submitBtn');
const progressSection = document.getElementById('progressSection');
const progressBar = document.getElementById('progressBar');
const progressPct = document.getElementById('progressPct');
const progressLog = document.getElementById('progressLog');
const resultSection = document.getElementById('resultSection');
const resultTitle = document.getElementById('resultTitle');
const resultSummary = document.getElementById('resultSummary');
const resultDetails = document.getElementById('resultDetails');
const downloadSection = document.getElementById('downloadSection');
const downloadBtn = document.getElementById('downloadBtn');

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const orderId = document.getElementById('order_id').value;
  const account = document.getElementById('account').value;
  const headless = document.getElementById('headless').checked;

  // Disable form
  submitBtn.disabled = true;
  submitBtn.textContent = 'Starting...';

  // Hide previous results
  resultSection.style.display = 'none';
  progressSection.style.display = 'block';
  progressBar.value = 0;
  progressPct.textContent = '0%';
  progressLog.textContent = '';

  try {
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('account', account);
    formData.append('headless', headless ? 'true' : 'false');

    const response = await fetch('{{ url_for("quote_scraper.scrape_quote") }}', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to start scraping');
    }

    currentJobId = data.job_id;
    startPolling();

  } catch (error) {
    alert('Error: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Start Scraping';
    progressSection.style.display = 'none';
  }
});

downloadBtn.addEventListener('click', () => {
  if (!resultData) return;

  const blob = new Blob([JSON.stringify(resultData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `quote_history_${resultData.order_id.substring(0, 8)}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

function startPolling() {
  if (poller) clearInterval(poller);

  poller = setInterval(async () => {
    try {
      const res = await fetch(
        `{{ url_for("quote_scraper.job_status", job_id="JOB_ID") }}`.replace('JOB_ID', currentJobId) +
        `?t=${Date.now()}`,
        { cache: 'no-store' }
      );

      const job = await res.json();
      updateProgress(job);

      if (job.status === 'completed' || job.status === 'failed' || job.status === 'aborted') {
        clearInterval(poller);
        showResult(job);
      }

    } catch (e) {
      console.error('Polling error:', e);
    }
  }, 500);
}

function updateProgress(job) {
  const pct = job.pct || 0;
  progressBar.value = pct;
  progressPct.textContent = pct + '%';

  if (job.log && job.log.length > 0) {
    progressLog.textContent = job.log.join('\n');
    progressLog.scrollTop = progressLog.scrollHeight;
  }
}

function showResult(job) {
  // Re-enable form
  submitBtn.disabled = false;
  submitBtn.textContent = 'Start Scraping';

  // Show result section
  resultSection.style.display = 'block';

  if (job.status === 'failed') {
    resultSection.classList.add('error');
    resultTitle.textContent = 'Error';
    resultSummary.innerHTML = `<strong class="err">Scraping failed:</strong><br>${job.error || 'Unknown error'}`;
    downloadSection.style.display = 'none';
  } else {
    resultSection.classList.remove('error');
    resultTitle.textContent = 'Success';

    const result = job.result || {};
    resultData = result;
    resultSummary.textContent = result.summary || 'Scraping completed';

    // Show download button
    downloadSection.style.display = 'block';

    // Show history entries in a table
    let detailsHtml = '<div style="margin-top: 1rem;">';

    if (result.errors && result.errors.length > 0) {
      detailsHtml += '<div class="warn" style="margin-bottom: 1rem;">';
      detailsHtml += '<strong>Warnings:</strong><ul>';
      result.errors.forEach(err => {
        detailsHtml += `<li>${err}</li>`;
      });
      detailsHtml += '</ul></div>';
    }

    if (result.entries && result.entries.length > 0) {
      detailsHtml += `<p><strong>Total Entries:</strong> ${result.total_entries}</p>`;
      detailsHtml += '<details open style="margin-top: 1rem;"><summary><strong>History Entries (first 10)</strong></summary>';
      detailsHtml += '<table class="history-table">';
      detailsHtml += '<thead><tr><th>Title</th><th>Date</th><th>User</th><th>Details</th></tr></thead>';
      detailsHtml += '<tbody>';

      const displayCount = Math.min(result.entries.length, 10);
      for (let i = 0; i < displayCount; i++) {
        const entry = result.entries[i];
        detailsHtml += '<tr>';
        detailsHtml += `<td>${escapeHtml(entry.changes_title)}</td>`;
        detailsHtml += `<td>${escapeHtml(entry.date)}</td>`;
        detailsHtml += `<td>${escapeHtml(entry.user)}</td>`;
        detailsHtml += `<td class="details-cell">${escapeHtml(entry.details)}</td>`;
        detailsHtml += '</tr>';
      }

      detailsHtml += '</tbody></table>';

      if (result.entries.length > 10) {
        detailsHtml += `<p style="margin-top: 0.5rem; font-style: italic;">Showing first 10 of ${result.entries.length} entries. Download JSON for complete data.</p>`;
      }

      detailsHtml += '</details>';
    }

    detailsHtml += '</div>';
    resultDetails.innerHTML = detailsHtml;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
{% endblock %}
