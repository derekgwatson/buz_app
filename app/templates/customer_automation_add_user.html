{% extends "layout.html" %}
{% block title %}Add User to Existing Customer{% endblock %}

{% block head %}
<style>
  .ok { color: #0a7f36; }
  .warn { color: #b54708; }
  .err { color: #b42318; }
  .info { color: #026aa2; }
  code { background: #f6f8fa; padding: 2px 6px; border-radius: 4px; }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 500;
  }

  .form-group input[type="text"],
  .form-group input[type="email"] {
    width: 100%;
    max-width: 400px;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 1rem;
  }

  .form-group input[type="checkbox"] {
    margin-right: 0.5rem;
  }

  .help-text {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.3rem;
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    font-weight: normal;
  }

  .btn {
    padding: 0.6rem 1.2rem;
    border: 0;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
  }

  .btn-primary {
    background: #2563eb;
    color: white;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  .btn-primary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: #6b7280;
    color: white;
    margin-left: 0.5rem;
  }

  .btn-secondary:hover {
    background: #4b5563;
  }

  #progressSection {
    display: none;
    margin-top: 2rem;
  }

  #progressBar {
    width: 100%;
    max-width: 600px;
    height: 30px;
  }

  #progressPct {
    margin-top: 0.5rem;
    font-size: 1.1rem;
    font-weight: 500;
  }

  #progressLog {
    margin-top: 1rem;
    padding: 1rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    max-height: 400px;
    overflow-y: auto;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  #resultSection {
    display: none;
    margin-top: 2rem;
    padding: 1rem;
    background: #f0fdf4;
    border: 1px solid #86efac;
    border-radius: 0.5rem;
    color: #065f46;
  }

  #resultSection.error {
    background: #fef2f2;
    border-color: #fca5a5;
    color: #991b1b;
  }

  .result-summary {
    margin-top: 0.5rem;
    white-space: pre-line;
  }

  .steps-list {
    margin-top: 1rem;
    padding-left: 1.5rem;
  }

  .steps-list li {
    margin: 0.3rem 0;
  }
</style>
{% endblock %}

{% block content %}
<h2>Add User to Existing Customer</h2>

<p class="info">Add a new user (login) for an existing customer in Buz. The customer will be found using an existing user's email address.</p>

<p><a href="{{ url_for('customer_automation.index') }}">‚Üê Back to Customer Automation</a></p>

<form id="addUserForm">
  <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">Find Customer</h3>

  <div class="form-group">
    <label for="existing_user_email">Existing User Email:</label>
    <input type="email" id="existing_user_email" name="existing_user_email" placeholder="existing.user@example.com" required>
    <p class="help-text">
      Email of any existing user for this customer. We'll use this to find the customer record.
    </p>
  </div>

  <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">New User Details</h3>

  <div class="form-group">
    <label for="first_name">First Name:</label>
    <input type="text" id="first_name" name="first_name" placeholder="John" required>
  </div>

  <div class="form-group">
    <label for="last_name">Last Name:</label>
    <input type="text" id="last_name" name="last_name" placeholder="Smith" required>
  </div>

  <div class="form-group">
    <label for="email">Email:</label>
    <input type="email" id="email" name="email" placeholder="new.user@example.com" required>
    <p class="help-text">
      Email address for the new user account
    </p>
  </div>

  <div class="form-group">
    <label for="phone">Phone Number (optional):</label>
    <input type="text" id="phone" name="phone" placeholder="0412345678">
    <p class="help-text">
      Optional. Mobile numbers (starting with 04) will be added to mobile field, others to phone field.
    </p>
  </div>

  <div class="form-group">
    <label>Buz Instances:</label>
    <div class="checkbox-group">
      <label>
        <input type="checkbox" name="buz_instances" value="Watson Blinds">
        Watson Blinds
      </label>
      <label>
        <input type="checkbox" name="buz_instances" value="Designer Drapes">
        Designer Drapes
      </label>
    </div>
    <p class="help-text">
      Select which Buz instance(s) to create the user in
    </p>
  </div>

  <div class="form-group">
    <label>
      <input type="checkbox" id="headless" name="headless">
      Run in headless mode (no browser window)
    </label>
  </div>

  <button type="submit" class="btn btn-primary" id="submitBtn">Add User</button>
  <a href="{{ url_for('customer_automation.index') }}" class="btn btn-secondary">Cancel</a>
</form>

<div id="progressSection">
  <h3>Progress</h3>
  <progress id="progressBar" max="100" value="0"></progress>
  <div id="progressPct">0%</div>
  <pre id="progressLog"></pre>
</div>

<div id="resultSection">
  <h3 id="resultTitle">Result</h3>
  <div class="result-summary" id="resultSummary"></div>
  <div id="resultDetails"></div>
</div>

<script>
let currentJobId = null;
let poller = null;

const form = document.getElementById('addUserForm');
const submitBtn = document.getElementById('submitBtn');
const progressSection = document.getElementById('progressSection');
const progressBar = document.getElementById('progressBar');
const progressPct = document.getElementById('progressPct');
const progressLog = document.getElementById('progressLog');
const resultSection = document.getElementById('resultSection');
const resultTitle = document.getElementById('resultTitle');
const resultSummary = document.getElementById('resultSummary');
const resultDetails = document.getElementById('resultDetails');

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const existingUserEmail = document.getElementById('existing_user_email').value;
  const firstName = document.getElementById('first_name').value;
  const lastName = document.getElementById('last_name').value;
  const email = document.getElementById('email').value;
  const phone = document.getElementById('phone').value;
  const headless = document.getElementById('headless').checked;

  // Get selected Buz instances
  const buzInstances = Array.from(document.querySelectorAll('input[name="buz_instances"]:checked'))
    .map(cb => cb.value);

  if (buzInstances.length === 0) {
    alert('Please select at least one Buz instance');
    return;
  }

  // Disable form
  submitBtn.disabled = true;
  submitBtn.textContent = 'Starting...';

  // Hide previous results
  resultSection.style.display = 'none';
  progressSection.style.display = 'block';
  progressBar.value = 0;
  progressPct.textContent = '0%';
  progressLog.textContent = '';

  try {
    const formData = new FormData();
    formData.append('existing_user_email', existingUserEmail);
    formData.append('first_name', firstName);
    formData.append('last_name', lastName);
    formData.append('email', email);
    if (phone) formData.append('phone', phone);
    formData.append('headless', headless ? 'true' : 'false');

    // Add multiple buz_instances
    buzInstances.forEach(instance => {
      formData.append('buz_instances', instance);
    });

    const response = await fetch('{{ url_for("customer_automation.add_user") }}', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to start automation');
    }

    currentJobId = data.job_id;
    startPolling();

  } catch (error) {
    alert('Error: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Add User';
    progressSection.style.display = 'none';
  }
});

function startPolling() {
  if (poller) clearInterval(poller);

  poller = setInterval(async () => {
    try {
      const res = await fetch(
        `{{ url_for("customer_automation.job_status", job_id="JOB_ID") }}`.replace('JOB_ID', currentJobId) +
        `?t=${Date.now()}`,
        { cache: 'no-store' }
      );

      const job = await res.json();
      updateProgress(job);

      if (job.status === 'completed' || job.status === 'failed' || job.status === 'aborted') {
        clearInterval(poller);
        showResult(job);
      }

    } catch (e) {
      console.error('Polling error:', e);
    }
  }, 500);
}

function updateProgress(job) {
  const pct = job.pct || 0;
  progressBar.value = pct;
  progressPct.textContent = pct + '%';

  if (job.log && job.log.length > 0) {
    progressLog.textContent = job.log.join('\n');
    progressLog.scrollTop = progressLog.scrollHeight;
  }
}

function showResult(job) {
  // Re-enable form
  submitBtn.disabled = false;
  submitBtn.textContent = 'Add User';

  // Show result section
  resultSection.style.display = 'block';

  if (job.status === 'failed') {
    resultSection.classList.add('error');
    resultTitle.textContent = 'Error';
    resultSummary.innerHTML = `<strong class="err">User addition failed:</strong><br>${job.error || 'Unknown error'}`;

    // Show steps if available even on error
    const result = job.result || {};
    if (result.steps && result.steps.length > 0) {
      let detailsHtml = '<details style="margin-top: 1rem;"><summary>Show error details</summary>';
      detailsHtml += '<ul class="steps-list">';
      result.steps.forEach(step => {
        detailsHtml += `<li>${step}</li>`;
      });
      detailsHtml += '</ul></details>';
      resultDetails.innerHTML = detailsHtml;
    }
  } else {
    resultSection.classList.remove('error');
    resultTitle.textContent = 'Success';

    const result = job.result || {};
    resultSummary.textContent = result.summary || 'User added successfully';

    // Show details
    let detailsHtml = '<div style="margin-top: 1rem;">';

    if (result.customer_name) {
      detailsHtml += `<p><strong>Customer:</strong> ${result.customer_name}</p>`;
    }

    if (result.user_email) {
      detailsHtml += `<p><strong>User Email:</strong> ${result.user_email}</p>`;
    }

    if (result.steps && result.steps.length > 0) {
      detailsHtml += '<details style="margin-top: 1rem;"><summary>Show detailed steps</summary>';
      detailsHtml += '<ul class="steps-list">';
      result.steps.forEach(step => {
        detailsHtml += `<li>${step}</li>`;
      });
      detailsHtml += '</ul></details>';
    }

    detailsHtml += '</div>';
    resultDetails.innerHTML = detailsHtml;
  }
}
</script>
{% endblock %}
