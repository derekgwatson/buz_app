{% extends "layout.html" %}
{% block title %}Customer Automation{% endblock %}

{% block head %}
<style>
  .ok { color: #0a7f36; }
  .warn { color: #b54708; }
  .err { color: #b42318; }
  .info { color: #026aa2; }
  code { background: #f6f8fa; padding: 2px 6px; border-radius: 4px; }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 500;
  }

  .form-group input[type="text"],
  .form-group input[type="number"] {
    width: 100%;
    max-width: 400px;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 1rem;
  }

  .form-group input[type="checkbox"] {
    margin-right: 0.5rem;
  }

  .btn {
    padding: 0.6rem 1.2rem;
    border: 0;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
  }

  .btn-primary {
    background: #2563eb;
    color: white;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  .btn-primary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  #progressSection {
    display: none;
    margin-top: 2rem;
  }

  #progressBar {
    width: 100%;
    max-width: 600px;
    height: 30px;
  }

  #progressPct {
    margin-top: 0.5rem;
    font-size: 1.1rem;
    font-weight: 500;
  }

  #progressLog {
    margin-top: 1rem;
    padding: 1rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    max-height: 400px;
    overflow-y: auto;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  #resultSection {
    display: none;
    margin-top: 2rem;
    padding: 1rem;
    background: #f0fdf4;
    border: 1px solid #86efac;
    border-radius: 0.5rem;
    color: #065f46;
  }

  #resultSection.error {
    background: #fef2f2;
    border-color: #fca5a5;
    color: #991b1b;
  }

  .result-summary {
    margin-top: 0.5rem;
    white-space: pre-line;
  }

  .steps-list {
    margin-top: 1rem;
    padding-left: 1.5rem;
  }

  .steps-list li {
    margin: 0.3rem 0;
  }
</style>
{% endblock %}

{% block content %}
<h2>Customer Automation</h2>

<p class="info">Automatically add customers and users to Buz from Zendesk tickets.</p>

<form id="automationForm">
  <div class="form-group">
    <label for="ticket_id">Zendesk Ticket ID:</label>
    <input type="number" id="ticket_id" name="ticket_id" placeholder="e.g., 12345" required>
    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.3rem;">
      Enter the Zendesk ticket number containing customer details
    </p>
  </div>

  <div class="form-group">
    <label>
      <input type="checkbox" id="headless" name="headless">
      Run in headless mode (no browser window)
    </label>
  </div>

  <button type="submit" class="btn btn-primary" id="submitBtn">Start Automation</button>
</form>

<div id="progressSection">
  <h3>Progress</h3>
  <progress id="progressBar" max="100" value="0"></progress>
  <div id="progressPct">0%</div>
  <pre id="progressLog"></pre>
</div>

<div id="resultSection">
  <h3 id="resultTitle">Result</h3>
  <div class="result-summary" id="resultSummary"></div>
  <div id="resultDetails"></div>
</div>

<script>
let currentJobId = null;
let poller = null;

const form = document.getElementById('automationForm');
const submitBtn = document.getElementById('submitBtn');
const progressSection = document.getElementById('progressSection');
const progressBar = document.getElementById('progressBar');
const progressPct = document.getElementById('progressPct');
const progressLog = document.getElementById('progressLog');
const resultSection = document.getElementById('resultSection');
const resultTitle = document.getElementById('resultTitle');
const resultSummary = document.getElementById('resultSummary');
const resultDetails = document.getElementById('resultDetails');

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const ticketId = document.getElementById('ticket_id').value;
  const headless = document.getElementById('headless').checked;

  // Disable form
  submitBtn.disabled = true;
  submitBtn.textContent = 'Starting...';

  // Hide previous results
  resultSection.style.display = 'none';
  progressSection.style.display = 'block';
  progressBar.value = 0;
  progressPct.textContent = '0%';
  progressLog.textContent = '';

  try {
    const formData = new FormData();
    formData.append('ticket_id', ticketId);
    formData.append('headless', headless ? 'true' : 'false');

    const response = await fetch('{{ url_for("customer_automation.add_from_zendesk") }}', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to start automation');
    }

    currentJobId = data.job_id;
    startPolling();

  } catch (error) {
    alert('Error: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Start Automation';
    progressSection.style.display = 'none';
  }
});

function startPolling() {
  if (poller) clearInterval(poller);

  poller = setInterval(async () => {
    try {
      const res = await fetch(
        `{{ url_for("customer_automation.job_status", job_id="JOB_ID") }}`.replace('JOB_ID', currentJobId) +
        `?t=${Date.now()}`,
        { cache: 'no-store' }
      );

      const job = await res.json();
      updateProgress(job);

      if (job.status === 'completed' || job.status === 'failed' || job.status === 'aborted') {
        clearInterval(poller);
        showResult(job);
      }

    } catch (e) {
      console.error('Polling error:', e);
    }
  }, 500);
}

function updateProgress(job) {
  const pct = job.pct || 0;
  progressBar.value = pct;
  progressPct.textContent = pct + '%';

  if (job.log && job.log.length > 0) {
    progressLog.textContent = job.log.join('\n');
    progressLog.scrollTop = progressLog.scrollHeight;
  }
}

function showResult(job) {
  // Re-enable form
  submitBtn.disabled = false;
  submitBtn.textContent = 'Start Automation';

  // Show result section
  resultSection.style.display = 'block';

  if (job.status === 'failed') {
    resultSection.classList.add('error');
    resultTitle.textContent = 'Error';
    resultSummary.innerHTML = `<strong class="err">Automation failed:</strong><br>${job.error || 'Unknown error'}`;
  } else {
    resultSection.classList.remove('error');
    resultTitle.textContent = 'Success';

    const result = job.result || {};
    resultSummary.textContent = result.summary || 'Automation completed';

    // Show details
    let detailsHtml = '<div style="margin-top: 1rem;">';

    if (result.customer_name) {
      detailsHtml += `<p><strong>Customer:</strong> ${result.customer_name}</p>`;
    }

    if (result.user_email) {
      detailsHtml += `<p><strong>User Email:</strong> ${result.user_email}</p>`;
    }

    if (result.steps && result.steps.length > 0) {
      detailsHtml += '<details style="margin-top: 1rem;"><summary>Show detailed steps</summary>';
      detailsHtml += '<ul class="steps-list">';
      result.steps.forEach(step => {
        detailsHtml += `<li>${step}</li>`;
      });
      detailsHtml += '</ul></details>';
    }

    detailsHtml += '</div>';
    resultDetails.innerHTML = detailsHtml;
  }
}
</script>
{% endblock %}
