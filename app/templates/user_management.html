{% extends "layout.html" %}
{% block title %}User Management Review{% endblock %}

{% block head %}
<style>
  .ok { color: #0a7f36; }
  .warn { color: #b54708; }
  .err { color: #b42318; }
  .info { color: #026aa2; }
  code { background: #f6f8fa; padding: 2px 6px; border-radius: 4px; }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 500;
  }

  .form-group input[type="checkbox"] {
    margin-right: 0.5rem;
  }

  .btn {
    padding: 0.6rem 1.2rem;
    border: 0;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
  }

  .btn-primary {
    background: #2563eb;
    color: white;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  .btn-primary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  #progressSection {
    display: none;
    margin-top: 2rem;
  }

  #progressBar {
    width: 100%;
    max-width: 600px;
    height: 30px;
  }

  #progressPct {
    margin-top: 0.5rem;
    font-size: 1.1rem;
    font-weight: 500;
  }

  #progressLog {
    margin-top: 1rem;
    padding: 1rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    max-height: 400px;
    overflow-y: auto;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  #resultSection {
    display: none;
    margin-top: 2rem;
  }

  #resultSection.error {
    background: #3d1a1a;
    border: 1px solid #dc2626;
    border-radius: 0.5rem;
    padding: 1rem;
    color: #fca5a5;
  }

  .result-summary {
    margin-bottom: 1rem;
    padding: 1rem;
    background: #1e3a1e;
    border: 1px solid #22c55e;
    border-radius: 0.5rem;
    color: #86efac;
    white-space: pre-line;
  }

  /* User table */
  .user-table {
    margin-top: 1.5rem;
    width: 100%;
    max-height: 700px;
    overflow: auto;
  }

  .user-table table {
    width: 100%;
    border-collapse: collapse;
    background: #2a2a2a;
    box-shadow: 0 1px 3px rgba(0,0,0,0.5);
  }

  .user-table th {
    background: #1f1f1f;
    padding: 0.85rem 1rem;
    text-align: left;
    font-weight: 600;
    color: #e0e0e0;
    border-bottom: 2px solid #444;
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 1.3rem;
  }

  .user-table td {
    padding: 0.7rem 1rem;
    border-bottom: 1px solid #444;
    color: #e0e0e0;
    font-size: 1.2rem;
  }

  .user-table tr:hover {
    background: #353535;
  }

  .user-table .email-col {
    font-family: monospace;
    font-weight: 500;
    color: #66d9ef;
    min-width: 200px;
  }

  .user-table .name-col {
    min-width: 150px;
  }

  .user-table .org-col {
    text-align: center;
    min-width: 120px;
    max-width: 150px;
  }

  .user-table .org-col.present {
    background: #1e3a1e;
  }

  .user-table .org-col.absent {
    background: #2a2a2a;
    color: #666;
  }

  .user-details {
    font-size: 1rem;
    color: #9ca3af;
    line-height: 1.5;
  }

  .user-details .badge {
    display: inline-block;
    padding: 0.3rem 0.6rem;
    margin: 0.2rem;
    background: #3b82f6;
    color: white;
    border-radius: 0.3rem;
    font-size: 0.95rem;
    font-weight: 500;
  }

  .user-details .badge.inactive {
    background: #6b7280;
  }

  .user-details .badge.mfa {
    background: #10b981;
  }

  .user-details .badge.employee {
    background: #8b5cf6;
  }

  .user-details .badge.customer {
    background: #f59e0b;
  }

  .user-details .badge.clickable {
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .user-details .badge.clickable:hover {
    opacity: 0.8;
  }

  .user-details .badge.clickable:active {
    opacity: 0.6;
  }

  .filter-bar {
    margin-top: 1rem;
    padding: 1rem;
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 0.5rem;
    color: #e0e0e0;
  }

  .filter-bar .filter-section {
    margin-bottom: 1rem;
  }

  .filter-bar .filter-section:last-child {
    margin-bottom: 0;
  }

  .filter-bar input[type="text"] {
    padding: 0.5rem;
    border: 1px solid #555;
    border-radius: 0.375rem;
    width: 300px;
    max-width: 100%;
    background: #333;
    color: #e0e0e0;
    font-size: 1rem;
  }

  .filter-bar label {
    margin-right: 0.5rem;
    font-weight: 500;
    color: #e0e0e0;
  }

  .filter-bar .filter-group {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-bar .filter-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .filter-bar input[type="checkbox"],
  .filter-bar input[type="radio"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .stats {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .stat-card {
    flex: 1;
    min-width: 150px;
    padding: 1rem;
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 0.5rem;
  }

  .stat-card .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #66d9ef;
  }

  .stat-card .stat-label {
    color: #9ca3af;
    font-size: 0.875rem;
  }

  .user-table tr.multi-org {
    border-left: 3px solid #3b82f6;
  }

  .user-table tr.inactive-all {
    opacity: 0.6;
  }
</style>
{% endblock %}

{% block content %}
<h2>User Management Review</h2>

<p class="info">
  Review all users across Buz organizations. This tool shows which users have access to which orgs,
  their roles, MFA status, and activity.
</p>

<div id="cachedDataInfo" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: #1e3a1e; border: 1px solid #22c55e; border-radius: 0.5rem; color: #86efac;">
  <strong>ðŸ“¦ Cached data available:</strong> Last updated <span id="cachedDataTime"></span>
  <button type="button" class="btn" onclick="loadCachedData()" style="margin-left: 1rem; padding: 0.4rem 0.8rem; background: #16a34a; font-size: 0.9rem;">Load Cached Data</button>
</div>

<details style="margin-bottom: 1.5rem; padding: 1rem; background: #2a2a2a; border: 1px solid #444; border-radius: 0.5rem;">
  <summary style="cursor: pointer; font-weight: 600; color: #66d9ef; user-select: none;">
    ðŸ’¡ How to Use
  </summary>
  <div style="margin-top: 1rem; color: #e0e0e0; line-height: 1.6;">
    <ol style="margin-left: 1.5rem;">
      <li><strong>Run Review:</strong> Select orgs and click "Start Review" to scrape user data from each Buz organization</li>
      <li><strong>View Results:</strong> Users are organized by email address. Each row shows which orgs the user has access to</li>
      <li><strong>Filter Users:</strong> Use the search box to filter by name or email. Toggle checkboxes to show only specific user types</li>
      <li><strong>Understand Colors:</strong>
        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
          <li>Green background = User has access to this org</li>
          <li>Blue left border = User has access to multiple orgs</li>
          <li>Faded row = User is inactive in all orgs they have access to</li>
        </ul>
      </li>
      <li><strong>User Details:</strong> Hover over an org cell to see: group, MFA status, active/inactive, user type, last login</li>
    </ol>
    <p style="margin-top: 1rem; padding: 0.75rem; background: #3d2e1a; border-left: 3px solid #fbbf24; border-radius: 0.25rem;">
      <strong>Note:</strong> This tool currently provides read-only access. Bulk editing functionality can be added in future versions.
    </p>
  </div>
</details>

<form id="reviewForm">
  <div class="form-group">
    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Select Organizations:</label>
    <div style="margin-left: 1rem;">
      <label style="display: block; margin: 0.3rem 0;">
        <input type="checkbox" name="orgs" value="canberra" checked>
        Canberra
      </label>
      <label style="display: block; margin: 0.3rem 0;">
        <input type="checkbox" name="orgs" value="tweed" checked>
        Tweed
      </label>
      <label style="display: block; margin: 0.3rem 0;">
        <input type="checkbox" name="orgs" value="dd" checked>
        Designer Drapes
      </label>
      <label style="display: block; margin: 0.3rem 0;">
        <input type="checkbox" name="orgs" value="bay" checked>
        Batemans Bay
      </label>
      <label style="display: block; margin: 0.3rem 0;">
        <input type="checkbox" name="orgs" value="shoalhaven" checked>
        Shoalhaven
      </label>
      <label style="display: block; margin: 0.3rem 0;">
        <input type="checkbox" name="orgs" value="wagga" checked>
        Wagga Wagga
      </label>
    </div>
  </div>

  {% if is_development %}
  <div class="form-group">
    <label>
      <input type="checkbox" id="headless" name="headless" checked>
      Run in headless mode (no browser window)
    </label>
  </div>
  {% endif %}

  <button type="submit" class="btn btn-primary" id="submitBtn">Refresh Data</button>
</form>

<div style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; display: none;" id="batchSection">
  <div style="display: flex; align-items: center; gap: 1rem;">
    <span style="font-weight: 500; font-size: 1.1rem;">Pending Changes: <strong id="pendingCount">0</strong></span>
    <button class="btn btn-primary" id="applyChangesBtn" onclick="applyBatchChanges()">Apply Changes</button>
    <button class="btn" style="background: #6b7280; color: white;" onclick="clearPendingChanges()">Clear</button>
  </div>
  <div id="pendingList" style="margin-top: 0.5rem; font-size: 0.95rem; color: #6b7280;"></div>
</div>

<div id="progressSection">
  <h3>Progress</h3>
  <progress id="progressBar" max="100" value="0"></progress>
  <div id="progressPct">0%</div>
  <pre id="progressLog"></pre>
</div>

<div id="resultSection">
  <h3 id="resultTitle">Results</h3>

  <div id="errorSection" style="display: none;">
    <div class="result-summary error" id="errorMessage"></div>
  </div>

  <div id="successSection" style="display: none;">
    <div class="result-summary" id="resultSummary"></div>

    <div class="stats" id="statsSection"></div>

    <div class="filter-bar">
      <div class="filter-section">
        <label for="searchInput" style="display: block; margin-bottom: 0.5rem;">Search:</label>
        <input type="text" id="searchInput" placeholder="Filter by name or email...">
      </div>

      <div class="filter-section">
        <label style="display: block; margin-bottom: 0.5rem;">Filter Options:</label>
        <div class="filter-group">
          <div class="filter-item">
            <input type="checkbox" id="showActiveOnly">
            <label for="showActiveOnly">Active only</label>
          </div>
          <div class="filter-item">
            <input type="checkbox" id="showMultiOrgOnly">
            <label for="showMultiOrgOnly">Multi-org only</label>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <label style="display: block; margin-bottom: 0.5rem;">User Type:</label>
        <div class="filter-group">
          <div class="filter-item">
            <input type="radio" id="userTypeAll" name="userType" value="all" checked>
            <label for="userTypeAll">All users</label>
          </div>
          <div class="filter-item">
            <input type="radio" id="userTypeEmployee" name="userType" value="employee">
            <label for="userTypeEmployee">Employees only</label>
          </div>
          <div class="filter-item">
            <input type="radio" id="userTypeCustomer" name="userType" value="customer">
            <label for="userTypeCustomer">Customers only</label>
          </div>
        </div>
      </div>
    </div>

    <div class="user-table">
      <table id="userTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>Full Name</th>
            <!-- Org columns will be added dynamically -->
          </tr>
        </thead>
        <tbody id="userTableBody">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
let currentJobId = null;
let poller = null;
let comparisonData = null;
let cachedJob = null;

const form = document.getElementById('reviewForm');
const submitBtn = document.getElementById('submitBtn');
const progressSection = document.getElementById('progressSection');
const progressBar = document.getElementById('progressBar');
const progressPct = document.getElementById('progressPct');
const progressLog = document.getElementById('progressLog');
const resultSection = document.getElementById('resultSection');
const errorSection = document.getElementById('errorSection');
const successSection = document.getElementById('successSection');
const errorMessage = document.getElementById('errorMessage');
const resultSummary = document.getElementById('resultSummary');
const statsSection = document.getElementById('statsSection');
const userTable = document.getElementById('userTable');
const userTableBody = document.getElementById('userTableBody');
const searchInput = document.getElementById('searchInput');
const showMultiOrgOnly = document.getElementById('showMultiOrgOnly');
const showActiveOnly = document.getElementById('showActiveOnly');

// Check for cached data on page load
async function checkForCachedData() {
  try {
    const response = await fetch('{{ url_for("user_management.get_latest_result") }}');
    if (response.ok) {
      cachedJob = await response.json();

      // Show cached data info
      const cachedInfo = document.getElementById('cachedDataInfo');
      const cachedTime = document.getElementById('cachedDataTime');

      const updatedAt = new Date(cachedJob.updated_at);
      const now = new Date();
      const diffMinutes = Math.floor((now - updatedAt) / 60000);

      let timeStr;
      if (diffMinutes < 60) {
        timeStr = `${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
      } else {
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) {
          timeStr = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
        } else {
          const diffDays = Math.floor(diffHours / 24);
          timeStr = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
        }
      }

      cachedTime.textContent = timeStr;
      cachedInfo.style.display = 'block';
    }
  } catch (error) {
    // No cached data available, that's fine
    console.log('No cached data available');
  }
}

function loadCachedData() {
  if (!cachedJob) return;

  // Hide the cached data info banner
  document.getElementById('cachedDataInfo').style.display = 'none';

  // Show result directly
  showResult(cachedJob);
}

// Load cached data on page load
checkForCachedData();

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const headless = document.getElementById('headless')?.checked ?? true;

  // Get selected orgs
  const selectedOrgs = Array.from(document.querySelectorAll('input[name="orgs"]:checked'))
    .map(cb => cb.value);

  // Validate at least one org is selected
  if (selectedOrgs.length === 0) {
    alert('Please select at least one organization');
    return;
  }

  // Disable form
  submitBtn.disabled = true;
  submitBtn.textContent = 'Refreshing...';

  // Hide cached data banner and previous results
  document.getElementById('cachedDataInfo').style.display = 'none';
  resultSection.style.display = 'none';
  progressSection.style.display = 'block';
  progressBar.value = 0;
  progressPct.textContent = '0%';
  progressLog.textContent = '';

  try {
    const formData = new FormData();
    formData.append('headless', headless ? 'true' : 'false');

    // Add each selected org
    selectedOrgs.forEach(org => {
      formData.append('orgs', org);
    });

    const response = await fetch('{{ url_for("user_management.start_review") }}', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to start review');
    }

    currentJobId = data.job_id;
    startPolling();

  } catch (error) {
    alert('Error: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Refresh Data';
    progressSection.style.display = 'none';
  }
});

function startPolling() {
  if (poller) clearInterval(poller);

  poller = setInterval(async () => {
    try {
      const res = await fetch(
        `{{ url_for("user_management.job_status", job_id="JOB_ID") }}`.replace('JOB_ID', currentJobId) +
        `?t=${Date.now()}`,
        { cache: 'no-store' }
      );

      const job = await res.json();
      updateProgress(job);

      if (job.status === 'completed' || job.status === 'failed' || job.status === 'aborted') {
        clearInterval(poller);
        showResult(job);
      }

    } catch (e) {
      console.error('Polling error:', e);
    }
  }, 500);
}

function updateProgress(job) {
  const pct = job.pct || 0;
  progressBar.value = pct;
  progressPct.textContent = pct + '%';

  if (job.log && job.log.length > 0) {
    progressLog.textContent = job.log.join('\n');
    progressLog.scrollTop = progressLog.scrollHeight;
  }
}

function showResult(job) {
  // Re-enable form
  submitBtn.disabled = false;
  submitBtn.textContent = 'Refresh Data';

  // Show result section
  resultSection.style.display = 'block';

  if (job.status === 'failed') {
    errorSection.style.display = 'block';
    successSection.style.display = 'none';
    errorMessage.textContent = job.error || 'Unknown error';
  } else {
    errorSection.style.display = 'none';
    successSection.style.display = 'block';

    const result = job.result || {};
    resultSummary.textContent = result.summary || 'Review completed';

    if (result.comparison) {
      comparisonData = result.comparison;
      renderComparison(comparisonData);
    }
  }
}

function renderComparison(comparison) {
  // Render stats
  const summary = comparison.summary || {};
  statsSection.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${summary.total_unique_users || 0}</div>
      <div class="stat-label">Unique Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${summary.users_in_multiple_orgs || 0}</div>
      <div class="stat-label">Multi-Org Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${summary.users_with_active_access || 0}</div>
      <div class="stat-label">Active Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${summary.users_with_inactive_access || 0}</div>
      <div class="stat-label">Inactive Users</div>
    </div>
  `;

  // Add org columns to table header
  const orgNames = comparison.org_names || [];
  const thead = userTable.querySelector('thead tr');

  // Remove existing org columns
  while (thead.children.length > 2) {
    thead.removeChild(thead.lastChild);
  }

  // Add org columns
  orgNames.forEach(orgName => {
    const th = document.createElement('th');
    th.textContent = orgName;
    th.style.textAlign = 'center';
    thead.appendChild(th);
  });

  // Render table rows
  renderTableRows(comparison);

  // Add event listeners for filtering
  searchInput.addEventListener('input', () => renderTableRows(comparison));
  showMultiOrgOnly.addEventListener('change', () => renderTableRows(comparison));
  showActiveOnly.addEventListener('change', () => renderTableRows(comparison));
  document.querySelectorAll('input[name="userType"]').forEach(radio => {
    radio.addEventListener('change', () => renderTableRows(comparison));
  });
}

function renderTableRows(comparison) {
  const users = comparison.users || [];
  const orgNames = comparison.org_names || [];
  const searchTerm = searchInput.value.toLowerCase();
  const multiOrgOnly = showMultiOrgOnly.checked;
  const activeOnly = showActiveOnly.checked;
  const userTypeFilter = document.querySelector('input[name="userType"]:checked').value;

  userTableBody.innerHTML = '';

  users.forEach(user => {
    // Apply search filter
    if (searchTerm) {
      const email = (user.email || '').toLowerCase();
      const name = (user.full_name || '').toLowerCase();
      if (!email.includes(searchTerm) && !name.includes(searchTerm)) {
        return;
      }
    }

    // Apply multi-org filter
    const orgCount = Object.keys(user.orgs || {}).length;
    if (multiOrgOnly && orgCount <= 1) {
      return;
    }

    // Check if user is active in any org
    const hasActiveAccess = Object.values(user.orgs || {}).some(org => org.is_active);

    // Apply active filter
    if (activeOnly && !hasActiveAccess) {
      return;
    }

    // Apply user type filter
    if (userTypeFilter !== 'all') {
      // Check if user has the specified user_type in any org
      const hasUserType = Object.values(user.orgs || {}).some(org => org.user_type === userTypeFilter);
      if (!hasUserType) {
        return;
      }
    }

    const tr = document.createElement('tr');

    // Add classes for styling
    if (orgCount > 1) {
      tr.classList.add('multi-org');
    }
    if (!hasActiveAccess) {
      tr.classList.add('inactive-all');
    }

    // Email column
    const emailTd = document.createElement('td');
    emailTd.className = 'email-col';
    emailTd.textContent = user.email || '-';
    tr.appendChild(emailTd);

    // Full Name column
    const nameTd = document.createElement('td');
    nameTd.className = 'name-col';
    nameTd.textContent = user.full_name || '-';
    tr.appendChild(nameTd);

    // Org columns
    orgNames.forEach(orgName => {
      const orgTd = document.createElement('td');
      orgTd.className = 'org-col';

      const orgData = user.orgs[orgName];
      if (orgData) {
        orgTd.classList.add('present');

        // Build tooltip with user details
        const details = [];
        details.push(`Group: ${orgData.group || 'N/A'}`);
        details.push(`MFA: ${orgData.mfa_enabled ? 'Enabled' : 'Disabled'}`);
        details.push(`Status: ${orgData.is_active ? 'Active' : 'Inactive'}`);
        details.push(`Type: ${orgData.user_type || 'N/A'}`);
        details.push(`Last Session: ${orgData.last_session || 'Never'}`);
        orgTd.title = details.join('\n');

        // Build badges display
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'user-details';

        // Group badge
        const groupBadge = document.createElement('span');
        groupBadge.className = 'badge';
        groupBadge.textContent = orgData.group || 'N/A';
        detailsDiv.appendChild(groupBadge);

        // Status badge (clickable to toggle)
        const statusBadge = document.createElement('span');
        statusBadge.className = orgData.is_active ? 'badge clickable' : 'badge inactive clickable';
        statusBadge.textContent = orgData.is_active ? 'âœ“' : 'âœ—';
        statusBadge.title = `${orgData.is_active ? 'Active' : 'Inactive'} (click to toggle)`;
        statusBadge.dataset.orgName = orgName;
        statusBadge.dataset.userEmail = user.email;
        statusBadge.dataset.isActive = orgData.is_active;
        statusBadge.dataset.userType = orgData.user_type;
        statusBadge.onclick = (e) => {
          e.stopPropagation();
          toggleUserStatus(orgName, user.email, orgData.is_active, orgData.user_type, statusBadge);
        };
        detailsDiv.appendChild(statusBadge);

        // MFA badge
        if (orgData.mfa_enabled) {
          const mfaBadge = document.createElement('span');
          mfaBadge.className = 'badge mfa';
          mfaBadge.textContent = 'MFA';
          detailsDiv.appendChild(mfaBadge);
        }

        // Type badge
        const typeBadge = document.createElement('span');
        typeBadge.className = `badge ${orgData.user_type}`;
        typeBadge.textContent = orgData.user_type === 'employee' ? 'Emp' : 'Cust';
        detailsDiv.appendChild(typeBadge);

        orgTd.appendChild(detailsDiv);
      } else {
        orgTd.classList.add('absent');
        orgTd.textContent = '-';
      }

      tr.appendChild(orgTd);
    });

    userTableBody.appendChild(tr);
  });
}

// Map org display names to org keys
const orgNameToKey = {
  'Canberra': 'canberra',
  'Tweed': 'tweed',
  'Designer Drapes': 'dd',
  'Batemans Bay': 'bay',
  'Shoalhaven': 'shoalhaven',
  'Wagga Wagga': 'wagga'
};

// Track pending toggle changes
const pendingChanges = new Map(); // Key: `${orgName}|${userEmail}`, Value: {orgName, orgKey, userEmail, currentlyActive, userType, badgeElement}

function toggleUserStatus(orgName, userEmail, currentlyActive, userType, badgeElement) {
  const orgKey = orgNameToKey[orgName];
  if (!orgKey) {
    alert(`Unknown org: ${orgName}`);
    return;
  }

  const changeKey = `${orgName}|${userEmail}`;

  // Check if already staged
  if (pendingChanges.has(changeKey)) {
    // Un-stage the change
    pendingChanges.delete(changeKey);
    badgeElement.style.backgroundColor = '';
  } else {
    // Stage the change
    pendingChanges.set(changeKey, {
      orgName,
      orgKey,
      userEmail,
      currentlyActive,
      userType,
      badgeElement
    });
    // Highlight the badge to show it's staged
    badgeElement.style.backgroundColor = '#fef3c7';
  }

  updatePendingUI();
}

function updatePendingUI() {
  const count = pendingChanges.size;
  const batchSection = document.getElementById('batchSection');
  const pendingCount = document.getElementById('pendingCount');
  const pendingList = document.getElementById('pendingList');

  if (count === 0) {
    batchSection.style.display = 'none';
  } else {
    batchSection.style.display = 'block';
    pendingCount.textContent = count;

    // Show list of pending changes
    const changes = Array.from(pendingChanges.values());
    const summary = changes.slice(0, 5).map(c =>
      `${c.userEmail} in ${c.orgName} â†’ ${c.currentlyActive ? 'INACTIVE' : 'ACTIVE'}`
    ).join(', ');

    if (changes.length > 5) {
      pendingList.textContent = summary + ` and ${changes.length - 5} more...`;
    } else {
      pendingList.textContent = summary;
    }
  }
}

function clearPendingChanges() {
  // Remove highlights
  for (const change of pendingChanges.values()) {
    change.badgeElement.style.backgroundColor = '';
  }
  pendingChanges.clear();
  updatePendingUI();
}

async function applyBatchChanges() {
  if (pendingChanges.size === 0) {
    alert('No pending changes');
    return;
  }

  if (!confirm(`Apply ${pendingChanges.size} change(s)?`)) {
    return;
  }

  const applyBtn = document.getElementById('applyChangesBtn');
  applyBtn.disabled = true;
  applyBtn.textContent = 'Applying...';

  // Prepare changes for batch API
  const changes = Array.from(pendingChanges.values()).map(c => ({
    org_key: c.orgKey,
    user_email: c.userEmail,
    is_active: c.currentlyActive,
    user_type: c.userType
  }));

  // Get headless checkbox value (if it exists in dev mode)
  const headlessCheckbox = document.getElementById('headless');
  const headless = headlessCheckbox ? headlessCheckbox.checked : true;

  try {
    const response = await fetch('{{ url_for("user_management.batch_toggle_users") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ changes, headless })
    });

    const result = await response.json();

    if (result.success) {
      // Update all badges based on results
      for (const res of result.results) {
        const changeKey = `${Object.keys(orgNameToKey).find(k => orgNameToKey[k] === res.org_key)}|${res.user_email}`;
        const change = pendingChanges.get(changeKey);

        if (change) {
          const badge = change.badgeElement;
          badge.className = res.new_state ? 'badge clickable' : 'badge inactive clickable';
          badge.textContent = res.new_state ? 'âœ“' : 'âœ—';
          badge.title = `${res.new_state ? 'Active' : 'Inactive'} (click to toggle)`;
          badge.dataset.isActive = res.new_state;
          badge.style.backgroundColor = '';

          // Update the comparison data
          const user = comparisonData.users.find(u => u.email === res.user_email);
          const orgName = Object.keys(orgNameToKey).find(k => orgNameToKey[k] === res.org_key);
          if (user && user.orgs[orgName]) {
            user.orgs[orgName].is_active = res.new_state;
          }
        }
      }

      pendingChanges.clear();
      updatePendingUI();

      alert(`Successfully applied ${result.processed} change(s)${result.failed > 0 ? `. ${result.failed} failed.` : ''}`);
    } else {
      alert(`Error: ${result.errors.length} changes failed`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  } finally {
    applyBtn.disabled = false;
    applyBtn.textContent = 'Apply Changes';
  }
}
</script>
{% endblock %}
